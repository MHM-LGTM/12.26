# 精灵图调试指南

## 🔍 问题排查步骤

让我们一步步找出精灵图丢失的原因。

---

## 📝 调试步骤

### 步骤1：检查模拟时的数据

1. 刷新页面（F5）
2. 上传图片 → 框选元素 → 运行模拟
3. **打开浏览器控制台**（F12 → Console）
4. 观察日志

**应该看到（在主页面）：**
```
[PhysicsInputBox] 后端返回的 objects 包含精灵图
[PhysicsInputBox] 更新 assignments，添加精灵图
```

---

### 步骤2：检查保存时的数据

1. 点击"下载动画"
2. 填写名称
3. 点击"保存"
4. **查看控制台日志**

**应该看到：**
```
[SaveAnimationModal] 准备保存动画: {
  title: "...",
  objectsCount: 3,
  hasSprites: "有精灵图"  ← 关键！应该是"有精灵图"
}
```

**如果显示"无精灵图"，说明：**
- `assignments` 中没有 `sprite_data_url`
- 模拟后的更新没有生效

---

### 步骤3：检查数据库中的数据

```bash
cd /www/wwwroot/physmath.cn/my-project49
sqlite3 backend/sql_app.db

# 查看最新保存的动画
SELECT id, title, substr(scene_data, 1, 200) FROM animations ORDER BY id DESC LIMIT 1;

.quit
```

**检查 scene_data 中是否包含 "sprite_data_url"**

---

### 步骤4：检查播放页加载的数据

1. 生成分享链接
2. 打开链接
3. **查看控制台日志**

**应该看到：**
```
[PlayPage] ========== 调试信息 ==========
[PlayPage] assignments 数量: 3
[PlayPage] 第一个物体的 sprite_data_url: data:image/png;base64,iVBOR...
[PlayPage] 转换后的 objects: [...]
[PlayPage] 第一个 object 的 sprite_data_url: data:image/png;base64,iVBOR...
```

**如果 sprite_data_url 是 null 或 undefined：**
- 说明数据库中的数据就没有精灵图
- 需要重新保存

---

## 🔧 可能的问题和解决

### 问题1：模拟后 assignments 没有更新

**检查：**
- 看控制台是否有 `[PhysicsInputBox] 更新 assignments` 日志
- 如果没有，说明更新代码没执行

**解决：**
- 确认代码已刷新
- 清除浏览器缓存（Ctrl+Shift+Delete）

### 问题2：保存时用的是旧数据

**检查：**
- 控制台显示 `hasSprites: "无精灵图"`

**解决：**
- 确认使用了 `getSceneData()` 函数
- 而不是静态的 `sceneData`

### 问题3：数据库中就没有精灵图

**检查：**
- 查询数据库，scene_data 中搜索 "sprite_data_url"
- 如果没有找到，说明保存时就没有

**解决：**
- 重新运行模拟
- 重新保存

---

## 🧪 完整测试流程

### A. 新建动画测试

```
1. 刷新页面（F5）
   ↓
2. 上传图片 → 框选3个元素
   ↓
3. 点击"开始模拟"
   查看控制台：是否有精灵图？
   ↓
4. 点击"下载动画" → 填写"精灵图测试" → 保存
   查看控制台：hasSprites 是什么？
   ↓
5. 点击"分享链接" → 复制
   ↓
6. 新标签页打开
   查看控制台：sprite_data_url 是什么？
   ↓
7. 观察画面：是否有精灵图？
```

### B. 如果还是没有精灵图

**请提供以下信息：**
1. 主页面运行模拟时的控制台日志
2. 保存时的控制台日志（特别是 `hasSprites` 的值）
3. 播放页的控制台日志（`sprite_data_url` 的值）

我会根据日志进一步排查。

---

## 📸 预期效果对比

### 主页面（应该有精灵图）
- 物块A：实际的图片（不是蓝色方块）
- 物块B：实际的图片（不是灰色方块）

### 播放页（修复后应该相同）
- 物块A：实际的图片（不是蓝色方块）✅
- 物块B：实际的图片（不是灰色方块）✅

---

**开始测试吧！关键是查看控制台的日志！** 🔍

如果还有问题，把控制台的日志发给我，我继续排查！
