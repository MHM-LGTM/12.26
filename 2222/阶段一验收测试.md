# 阶段一验收测试指南

## ✅ 已完成的工作

### 后端部分
- ✅ 创建 `Animation` 和 `AnimationLike` 数据模型
- ✅ 创建 `animation_schema.py` (请求/响应 Schema)
- ✅ 创建 `animation_router.py` (API 路由)
- ✅ 在 `main.py` 中挂载动画路由
- ✅ 运行数据库初始化，创建表成功

### 前端部分
- ✅ 在 `PhysicsInputBox` 添加状态管理
- ✅ 在模拟成功后显示"下载动画"按钮
- ✅ 创建 `SaveAnimationModal` 保存弹窗组件
- ✅ 连接后端 API 保存动画

---

## 🧪 测试步骤

### 准备工作

#### 1. 启动后端服务
```bash
cd /www/wwwroot/physmath.cn/my-project49
source myenv/bin/activate
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**预期结果：**
- 看到 "Application startup complete" 信息
- 没有导入错误或启动错误

#### 2. 启动前端服务（新终端）
```bash
cd /www/wwwroot/physmath.cn/my-project49/frontend
npm run dev
```

**预期结果：**
- Vite 启动成功
- 显示访问地址（通常是 http://localhost:5174）

---

### 功能测试

#### 测试 1：下载按钮显示
1. ✅ 打开浏览器，访问前端地址
2. ✅ 登录账号（如果没登录）
3. ✅ 进入物理模拟页面
4. ✅ 上传一张物理场景图片（例如：小球、斜面）
5. ✅ 框选元素，分配标签
6. ✅ 点击"开始模拟"按钮
7. ✅ 观察模拟运行

**验收点：**
- [ ] 模拟运行后，画布下方出现 **"⬇️ 下载动画"** 按钮
- [ ] 按钮样式正确（紫色渐变，有阴影）
- [ ] 鼠标悬浮时有动画效果

**截图：** 请截图保存

---

#### 测试 2：保存弹窗显示
1. ✅ 点击"⬇️ 下载动画"按钮

**验收点：**
- [ ] 弹窗正常弹出
- [ ] 显示背景遮罩（半透明黑色）
- [ ] 弹窗标题："保存动画到我的动画库"
- [ ] 显示封面图预览（就是上传的背景图）
- [ ] 有"动画名称"输入框（必填，标红星）
- [ ] 有"描述"输入框（可选）
- [ ] 有字数统计（名称 0/100，描述 0/500）
- [ ] 有"取消"和"保存"按钮

**截图：** 请截图保存

---

#### 测试 3：保存功能
1. ✅ 在"动画名称"输入框输入：`弹性碰撞测试`
2. ✅ 在"描述"输入框输入：`测试保存功能`
3. ✅ 点击"保存"按钮

**验收点：**
- [ ] 按钮变为"保存中..."，禁用状态
- [ ] 保存成功后弹出提示："✅ 保存成功！"
- [ ] 弹窗自动关闭
- [ ] 没有控制台错误

**截图：** 请截图保存成功提示

---

#### 测试 4：数据库验证
在终端执行：
```bash
cd /www/wwwroot/physmath.cn/my-project49
sqlite3 backend/sql_app.db

# 在 SQLite 提示符下执行：
SELECT id, user_id, title, description, created_at FROM animations;

# 查看详细信息（可选）
SELECT id, title, is_public, like_count FROM animations;

# 退出
.quit
```

**验收点：**
- [ ] 能看到刚才保存的记录
- [ ] `title` 字段为 "弹性碰撞测试"
- [ ] `description` 字段为 "测试保存功能"
- [ ] `user_id` 对应你的登录用户ID
- [ ] `is_public` 为 0 (false)
- [ ] `like_count` 为 0
- [ ] `created_at` 有时间戳

**示例输出：**
```
id  user_id  title         description      created_at
1   1        弹性碰撞测试  测试保存功能     2025-12-11 19:30:00
```

---

#### 测试 5：边界情况测试

##### 5.1 未登录保存
1. ✅ 退出登录
2. ✅ 运行模拟后点击"下载动画"
3. ✅ 在弹窗中点击"保存"

**验收点：**
- [ ] 提示"请先登录后再保存动画"

##### 5.2 空标题保存
1. ✅ 登录后打开保存弹窗
2. ✅ 不填写标题，直接点击"保存"

**验收点：**
- [ ] 提示"请输入动画名称"
- [ ] 或者"保存"按钮处于禁用状态

##### 5.3 标题长度限制
1. ✅ 输入超过100个字符的标题

**验收点：**
- [ ] 输入框限制在100个字符
- [ ] 字数统计正确显示

##### 5.4 描述长度限制
1. ✅ 输入超过500个字符的描述

**验收点：**
- [ ] 输入框限制在500个字符
- [ ] 字数统计正确显示

---

#### 测试 6：多次保存
1. ✅ 保存第一个动画："动画1"
2. ✅ 修改参数，重新运行模拟
3. ✅ 再次点击"下载动画"，保存为"动画2"
4. ✅ 查询数据库

**验收点：**
- [ ] 数据库中有两条记录
- [ ] 两条记录的 `title` 不同
- [ ] 两条记录的 `created_at` 不同
- [ ] 两条记录的 `scene_data` 可能不同

---

## 📋 验收清单

### 功能验收
- [ ] ✅ 运行模拟后显示下载按钮
- [ ] ✅ 点击按钮弹出保存弹窗
- [ ] ✅ 弹窗显示封面图预览
- [ ] ✅ 填写标题后保存成功
- [ ] ✅ 保存成功提示显示
- [ ] ✅ 数据库记录正确

### 界面验收
- [ ] ✅ 下载按钮样式美观
- [ ] ✅ 弹窗样式美观
- [ ] ✅ 输入框焦点效果正常
- [ ] ✅ 按钮悬浮效果正常
- [ ] ✅ 字数统计实时更新

### 数据验收
- [ ] ✅ `title` 字段保存正确
- [ ] ✅ `description` 字段保存正确
- [ ] ✅ `thumbnail_url` 保存了封面图
- [ ] ✅ `scene_data` 包含完整数据：
  - imagePreview
  - imageNaturalSize
  - objects (assignments)
  - constraints (constraintRelations)
- [ ] ✅ `user_id` 正确关联
- [ ] ✅ `is_public` 默认为 false
- [ ] ✅ `like_count` 默认为 0

### 错误处理验收
- [ ] ✅ 未登录提示正确
- [ ] ✅ 空标题提示或禁用保存
- [ ] ✅ 网络错误有提示
- [ ] ✅ 控制台无报错

---

## 🐛 常见问题排查

### 问题 1：点击"下载动画"按钮没反应
**排查步骤：**
1. 打开浏览器控制台（F12）
2. 查看 Console 是否有报错
3. 检查 `showSaveModal` 状态是否改变
4. 检查弹窗的 `isOpen` 属性

### 问题 2：保存时提示 401 或 403
**排查步骤：**
1. 检查是否已登录
2. 检查 token 是否存在：`localStorage.getItem('authToken')`
3. 检查后端是否正确验证 token
4. 查看后端日志

### 问题 3：保存成功但数据库没有记录
**排查步骤：**
1. 检查后端控制台是否有报错
2. 查看数据库文件路径是否正确
3. 尝试直接用 SQLite 查询
4. 检查事务是否提交（`await db.commit()`）

### 问题 4：封面图不显示
**排查步骤：**
1. 检查 `sceneData.imagePreview` 是否有值
2. 检查是否是 data URL 格式
3. 在控制台打印 `sceneData`
4. 检查图片标签的 src 属性

---

## ✅ 阶段一完成标准

当所有以下项都完成时，阶段一验收通过：

1. ✅ 运行模拟后看到"下载动画"按钮
2. ✅ 点击按钮弹出保存弹窗
3. ✅ 弹窗显示封面图预览
4. ✅ 填写名称后保存成功
5. ✅ 数据库中能查到新记录
6. ✅ 边界情况处理正确
7. ✅ 没有明显的 UI bug
8. ✅ 没有控制台报错

---

## 🎉 完成后的截图

请保存以下截图：
1. 下载按钮显示效果
2. 保存弹窗完整界面
3. 保存成功提示
4. 数据库查询结果

将截图保存到：`/www/wwwroot/physmath.cn/my-project49/screenshots/stage1/`

---

**祝测试顺利！如有任何问题，请随时反馈。** 🚀

